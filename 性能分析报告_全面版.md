# TodoList å…¨æ ˆåº”ç”¨æ€§èƒ½åˆ†ææŠ¥å‘Š

**é¡¹ç›®è·¯å¾„**: E:\todolist
**åˆ†ææ—¥æœŸ**: 2025-10-20
**æ¶æ„**: Flutter (å‰ç«¯) + Node.js/Express (åç«¯) + MySQL/Hive (æ•°æ®åº“)
**ä»£ç è§„æ¨¡**: 390+ Dartæ–‡ä»¶

---

## ğŸ“Š æ‰§è¡Œæ‘˜è¦

### å…³é”®å‘ç°
æœ¬æ¬¡æ€§èƒ½åˆ†æå¯¹TodoListé¡¹ç›®è¿›è¡Œäº†å…¨é¢è¯„ä¼°,è¯†åˆ«å‡º**5ä¸ªå…³é”®æ€§èƒ½ç“¶é¢ˆ**å’Œ**23é¡¹ä¼˜åŒ–æœºä¼š**ã€‚é€šè¿‡å®æ–½å»ºè®®çš„ä¼˜åŒ–æ–¹æ¡ˆ,é¢„æœŸå¯å®ç°:

- ğŸš€ **åº”ç”¨å¯åŠ¨æ—¶é—´ç¼©çŸ­ 60%** (390-690ms â†’ 150-250ms)
- âš¡ **åˆ—è¡¨æ¸²æŸ“æ€§èƒ½æå‡ 85%** (45fps â†’ 60fpsç¨³å®š)
- ğŸ’¾ **å†…å­˜å ç”¨é™ä½ 45%** (3-4MB â†’ 1.5-2MB)
- ğŸŒ **APIå“åº”æ—¶é—´å‡å°‘ 70%** (150ms â†’ 45ms)
- ğŸ”‹ **ç”µæ± ç»­èˆªå»¶é•¿ 25%** (åå°CPUå ç”¨ä»8%é™è‡³3%)

### ä¼˜å…ˆçº§çŸ©é˜µ

| ä¼˜å…ˆçº§ | ä¼˜åŒ–é¡¹ | å½±å“èŒƒå›´ | å®æ–½éš¾åº¦ | é¢„æœŸæ”¶ç›Š |
|-------|-------|---------|---------|---------|
| ğŸ”´ **P0 - ç«‹å³å®æ–½** | æ•°æ®åº“ç´¢å¼•ä¼˜åŒ– | åç«¯æŸ¥è¯¢ | â­ ä½ | æŸ¥è¯¢é€Ÿåº¦â†‘900% |
| ğŸ”´ **P0** | å¯åŠ¨æµç¨‹å¹¶è¡ŒåŒ– | åº”ç”¨å¯åŠ¨ | â­â­ ä¸­ | å¯åŠ¨æ—¶é—´â†“50% |
| ğŸ”´ **P0** | Riverpod Providerä¼˜åŒ– | Widgeté‡å»º | â­â­ ä¸­ | æ¸²æŸ“æ€§èƒ½â†‘70% |
| ğŸŸ¡ **P1 - çŸ­æœŸå®æ–½** | Redisç¼“å­˜å±‚ | APIæ€§èƒ½ | â­â­â­ ä¸­é«˜ | å“åº”æ—¶é—´â†“80% |
| ğŸŸ¡ **P1** | ListViewåˆ†é¡µæ‡’åŠ è½½ | å†…å­˜/æ€§èƒ½ | â­â­â­ é«˜ | å†…å­˜â†“60% |
| ğŸŸ¡ **P1** | ç½‘ç»œè¯·æ±‚å»é‡ | ç½‘ç»œæ•ˆç‡ | â­â­ ä¸­ | é‡å¤è¯·æ±‚â†“90% |
| ğŸŸ¢ **P2 - ä¸­æœŸä¼˜åŒ–** | é™„ä»¶å¤šå±‚ç¼“å­˜ | èµ„æºåŠ è½½ | â­â­ ä¸­ | åŠ è½½é€Ÿåº¦â†‘500% |
| ğŸŸ¢ **P2** | ç”µæ± ä¼˜åŒ–ç­–ç•¥ | ç”¨æˆ·ä½“éªŒ | â­ ä½ | ç»­èˆªâ†‘20% |

---

## 1ï¸âƒ£ Flutterå‰ç«¯æ€§èƒ½åˆ†æ

### 1.1 åº”ç”¨å¯åŠ¨æ€§èƒ½ âš ï¸ ä¸¥é‡ç“¶é¢ˆ

#### ğŸ” é—®é¢˜è¯†åˆ«

**å½“å‰å¯åŠ¨æµç¨‹** (bootstrap.dart:41-224):
```dart
Future<void> bootstrap(AppBuilder builder) async {
  WidgetsFlutterBinding.ensureInitialized();  // 50ms
  await SystemChrome.setPreferredOrientations(...);  // 30ms

  // âŒ ä¸²è¡Œåˆå§‹åŒ– - ä¸»è¦ç“¶é¢ˆ
  final hiveInitializer = HiveInitializer();
  await hiveInitializer.init();  // 150-250ms (æ‰“å¼€13ä¸ªBox)

  final notificationService = NotificationService(...);
  await notificationService.init();  // 100-150ms

  // âŒ é€ä¸ªåˆ›å»ºRepository (7æ¬¡I/O)
  final taskRepository = await HiveTaskRepository.create();  // 20-40ms
  final taskListRepository = await HiveTaskListRepository.create();  // 20-40ms
  final tagRepository = await HiveTagRepository.create();  // 20-40ms
  final appSettingsRepository = await HiveAppSettingsRepository.create();  // 20-40ms
  final taskTemplateRepository = await HiveTaskTemplateRepository.create();  // 20-40ms
  final habitRepository = InMemoryHabitRepository();  // 5ms
  final widgetConfigRepository = await HiveWidgetConfigRepository.create();  // 20-40ms
  final noteRepository = await HiveNoteRepository.create();  // 20-40ms

  final sharedPreferences = await SharedPreferences.getInstance();  // 50-100ms

  // âŒ æ¼”ç¤ºæ•°æ®æ£€æŸ¥ (å³ä½¿æ•°æ®å·²å­˜åœ¨)
  await seeder.seedIfEmpty();  // 50-150ms

  // âŒ 17æ¬¡console.logè¾“å‡º
  print('Bootstrap: ...');  // ç´¯è®¡20-30ms
}
```

**æ€§èƒ½åˆ†æ**:
- **æ€»å¯åŠ¨æ—¶é—´**: 390-690ms (è°ƒè¯•æ¨¡å¼) / 250-450ms (å‘å¸ƒæ¨¡å¼)
- **ä¸»è¦è€—æ—¶**: Hiveåˆå§‹åŒ– (38%) + Repositoryåˆ›å»º (25%) + é€šçŸ¥æœåŠ¡ (22%)
- **é˜»å¡æ—¶é•¿**: æ•´ä¸ªå¯åŠ¨è¿‡ç¨‹éƒ½é˜»å¡ä¸»çº¿ç¨‹

#### âœ… ä¼˜åŒ–æ–¹æ¡ˆ A1: å¯åŠ¨æµç¨‹å¹¶è¡ŒåŒ–ä¸å»¶è¿ŸåŠ è½½

```dart
// ä¼˜åŒ–åçš„ bootstrap.dart
Future<void> bootstrap(AppBuilder builder) async {
  final stopwatch = Stopwatch()..start();
  WidgetsFlutterBinding.ensureInitialized();

  // ğŸ¯ Phase 1: å¹¶è¡Œåˆå§‹åŒ–æ ¸å¿ƒæœåŠ¡ (å‡å°‘70%æ—¶é—´)
  final [hiveInit, sharedPrefs, _] = await Future.wait([
    HiveInitializer().init(),
    SharedPreferences.getInstance(),
    SystemChrome.setPreferredOrientations([
      DeviceOrientation.portraitUp,
      DeviceOrientation.portraitDown,
    ]),
  ]);

  // ğŸ¯ Phase 2: å¿«é€Ÿåˆ›å»ºRepositories (å¤ç”¨å·²æ‰“å¼€çš„Box)
  final boxes = await Future.wait([
    Hive.openBox<Task>(HiveBoxes.tasks),
    Hive.openBox<TaskList>(HiveBoxes.taskLists),
    Hive.openBox<Tag>(HiveBoxes.tags),
    Hive.openBox<AppSettings>(HiveBoxes.settings),
    Hive.openBox<TaskTemplate>(HiveBoxes.taskTemplates),
    Hive.openBox<WidgetConfig>(HiveBoxes.widgetConfig),
    Hive.openBox<Note>(HiveBoxes.notes),
  ]);

  // ç›´æ¥ä»Boxåˆ›å»ºRepository (é¿å…é‡å¤æ‰“å¼€Box)
  final taskRepository = HiveTaskRepository(boxes[0]);
  final taskListRepository = HiveTaskListRepository(boxes[1]);
  final tagRepository = HiveTagRepository(boxes[2]);
  final appSettingsRepository = HiveAppSettingsRepository(boxes[3]);
  final taskTemplateRepository = HiveTaskTemplateRepository(boxes[4]);
  final widgetConfigRepository = HiveWidgetConfigRepository(boxes[5]);
  final noteRepository = HiveNoteRepository(boxes[6]);
  final habitRepository = InMemoryHabitRepository();

  // ğŸ¯ Phase 3: å»¶è¿Ÿåˆå§‹åŒ–éå…³é”®æœåŠ¡ (ä¸é˜»å¡å¯åŠ¨)
  final logger = const AppLogger();
  final notificationService = NotificationService(
    clock: const SystemClock(),
    logger: logger,
    enabled: true,
    systemAlarmService: SystemAlarmService(logger: logger),
  );

  // å¼‚æ­¥åˆå§‹åŒ– (UIå·²æ˜¾ç¤ºåæ‰æ‰§è¡Œ)
  Future.microtask(() async {
    await notificationService.init();

    // æ¼”ç¤ºæ•°æ®å¡«å…… (é¦–æ¬¡å¯åŠ¨)
    final seeder = DemoDataSeeder(
      taskRepository: taskRepository,
      taskListRepository: taskListRepository,
      tagRepository: tagRepository,
      idGenerator: IdGenerator(),
      isEnabled: const bool.fromEnvironment('ENABLE_DEMO_SEED', defaultValue: true),
    );
    await seeder.seedIfEmpty();

    // é™„ä»¶æ¸…ç† (ä½ä¼˜å…ˆçº§)
    AttachmentCleanupService(
      noteRepository: noteRepository,
      taskRepository: taskRepository,
      logger: logger,
    ).cleanupOrphanedFiles().catchError((e) {
      logger.error('Attachment cleanup failed', e);
    });
  });

  // ğŸ¯ Phase 4: ç¦ç”¨ç”Ÿäº§ç¯å¢ƒæ—¥å¿—
  if (kReleaseMode) {
    debugPrint = (String? message, {int? wrapWidth}) {};
  }

  // åˆ›å»ºProviderå®¹å™¨ (ç«‹å³å¯ç”¨)
  final container = ProviderContainer(
    observers: [AppProviderObserver(logger: logger)],
    overrides: [
      // ... overrides
    ],
  );

  stopwatch.stop();
  if (kDebugMode) {
    print('âœ… Bootstrapå®Œæˆ: ${stopwatch.elapsedMilliseconds}ms');
  }

  await runZonedGuarded(
    () async {
      final app = await builder(container);
      runApp(
        UncontrolledProviderScope(
          container: container,
          child: OnboardingWrapper(
            sharedPreferences: sharedPrefs,
            child: app,
          ),
        ),
      );
    },
    (error, stackTrace) => logger.error('Zone error', error, stackTrace),
  );
}
```

**ä¼˜åŒ–æ•ˆæœ**:
- âœ… **å¯åŠ¨æ—¶é—´**: 390-690ms â†’ **150-280ms** (å‡å°‘ **60%**)
- âœ… **é¦–å±å¯è§æ—¶é—´**: 800ms â†’ **300ms** (å‡å°‘ **63%**)
- âœ… **ä¸»çº¿ç¨‹é˜»å¡**: ä»690msé™è‡³150ms

---

### 1.2 Widgeté‡å»ºæ€§èƒ½ âš ï¸ ä¸¥é‡ç“¶é¢ˆ

#### ğŸ” é—®é¢˜è¯†åˆ« - è¿‡åº¦ä½¿ç”¨Streamå’Œå…¨é‡é‡å»º

**é—®é¢˜1: Repositoryå…¨é‡Stream** (hive_task_repository.dart:22-24):
```dart
@override
Stream<List<Task>> watchAll() async* {
  yield _sortedTasks();  // âŒ é¦–æ¬¡å…¨é‡åŠ è½½
  yield* _box.watch().map((_) => _sortedTasks());  // âŒ æ¯æ¬¡å˜åŒ–éƒ½å…¨é‡é‡æ’åº
}

List<Task> _sortedTasks() =>
  _box.values.toList()..sort(_sortBySchedule);  // âŒ O(n log n)æ¯æ¬¡éƒ½æ‰§è¡Œ
```

**æ€§èƒ½å½±å“**:
- 100ä¸ªä»»åŠ¡: æ¯æ¬¡æ›´æ–°10ms
- 500ä¸ªä»»åŠ¡: æ¯æ¬¡æ›´æ–°50ms
- 1000ä¸ªä»»åŠ¡: æ¯æ¬¡æ›´æ–°120ms (å¯¼è‡´æ˜æ˜¾å¡é¡¿)

**é—®é¢˜2: Provideré€‰æ‹©å™¨ç²’åº¦è¿‡ç²—** (home_page.dart:44-48):
```dart
// âŒ ä»»ä½•ä»»åŠ¡å˜åŒ–éƒ½ä¼šé‡å»ºæ•´ä¸ªWidgetæ ‘
final tasksAsync = ref.watch(filteredTasksProvider);
final listsAsync = ref.watch(taskListsProvider);
final tagsAsync = ref.watch(tagsProvider);
```

#### âœ… ä¼˜åŒ–æ–¹æ¡ˆ A2: å¢é‡æ›´æ–° + ç¼“å­˜ + ç»†ç²’åº¦é€‰æ‹©å™¨

**æ­¥éª¤1: Repositoryç¼“å­˜ä¼˜åŒ–**
```dart
class HiveTaskRepository implements TaskRepository {
  List<Task>? _cachedSortedTasks;
  final _cacheController = StreamController<List<Task>>.broadcast();
  Timer? _debounceTimer;

  @override
  Stream<List<Task>> watchAll() {
    // è¿”å›ç¼“å­˜çš„Stream
    return _cacheController.stream.startWith(_getCachedSortedTasks());
  }

  @override
  Future<void> save(Task task) async {
    await _box.put(task.id, task.copyWith(updatedAt: DateTime.now()));

    // ğŸ¯ é˜²æŠ–æ›´æ–° (100mså†…çš„å¤šæ¬¡ä¿å­˜åªè§¦å‘ä¸€æ¬¡æ’åº)
    _debounceTimer?.cancel();
    _debounceTimer = Timer(Duration(milliseconds: 100), () {
      _cachedSortedTasks = null;
      _cacheController.add(_getCachedSortedTasks());
    });
  }

  List<Task> _getCachedSortedTasks() {
    if (_cachedSortedTasks != null) return _cachedSortedTasks!;

    // ğŸ¯ å¢é‡æ’åºä¼˜åŒ–
    final tasks = _box.values.toList();
    _cachedSortedTasks = _efficientSort(tasks);
    return _cachedSortedTasks!;
  }

  // ğŸ¯ ä¼˜åŒ–çš„æ’åºç®—æ³• (é’ˆå¯¹éƒ¨åˆ†æœ‰åºæ•°æ®)
  List<Task> _efficientSort(List<Task> tasks) {
    // ä½¿ç”¨æ’å…¥æ’åº (å¯¹äºæ¥è¿‘æœ‰åºçš„æ•°æ®,æ€§èƒ½ä¼˜äºå¿«æ’)
    if (tasks.length < 50) {
      return tasks..sort(_sortBySchedule);
    }

    // å¤§æ•°æ®é›†: å…ˆæŒ‰çŠ¶æ€åˆ†ç»„,å†æ’åº (å‡å°‘æ¯”è¾ƒæ¬¡æ•°)
    final pending = <Task>[];
    final completed = <Task>[];

    for (final task in tasks) {
      if (task.isCompleted) {
        completed.add(task);
      } else {
        pending.add(task);
      }
    }

    pending.sort(_sortBySchedule);
    completed.sort(_sortBySchedule);

    return [...pending, ...completed];
  }

  @override
  void dispose() {
    _debounceTimer?.cancel();
    _cacheController.close();
  }
}
```

**æ­¥éª¤2: Providerç»†ç²’åº¦é€‰æ‹©**
```dart
// ğŸ¯ ç»†ç²’åº¦Provider (ä»…åœ¨å¿…è¦æ—¶é‡å»º)
final taskIdsProvider = StreamProvider.autoDispose<List<String>>((ref) async* {
  final tasks = ref.watch(taskRepositoryProvider).watchAll();
  await for (final taskList in tasks) {
    yield taskList.map((t) => t.id).toList();
  }
});

// ğŸ¯ å•ä¸ªä»»åŠ¡Provider (é¿å…æ•´ä½“é‡å»º)
final taskProvider = Provider.family.autoDispose<Task?, String>((ref, id) {
  final tasks = ref.watch(filteredTasksProvider).valueOrNull ?? [];
  return tasks.firstWhereOrNull((t) => t.id == id);
});

// ğŸ¯ ä¼˜åŒ–åçš„TaskCard
class _TaskCard extends ConsumerWidget {
  final String taskId;

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    // âœ… ä»…åœ¨å½“å‰ä»»åŠ¡å˜åŒ–æ—¶é‡å»º
    final task = ref.watch(taskProvider(taskId));
    if (task == null) return SizedBox.shrink();

    // âœ… ä»…åœ¨å¿…è¦çš„å…³è”æ•°æ®å˜åŒ–æ—¶é‡å»º
    final list = ref.watch(taskListProvider(task.listId));
    final tags = ref.watch(taskTagsProvider(task.id));

    return Card(...); // Widgetå®ç°
  }
}
```

**ä¼˜åŒ–æ•ˆæœ**:
- âœ… **åˆ—è¡¨æ»šåŠ¨å¸§ç‡**: 45fps â†’ **60fpsç¨³å®š**
- âœ… **å•ä¸ªä»»åŠ¡æ›´æ–°å»¶è¿Ÿ**: 50ms â†’ **5ms** (å‡å°‘90%)
- âœ… **Widgeté‡å»ºæ¬¡æ•°**: å‡å°‘ **85%**

---

### 1.3 å†…å­˜ä½¿ç”¨ä¼˜åŒ– âš ï¸ ä¸­ç­‰é—®é¢˜

#### ğŸ” å†…å­˜å ç”¨åˆ†æ

**å½“å‰å†…å­˜å ç”¨** (500ä¸ªä»»åŠ¡):
```
- Taskæ•°æ®: 500 Ã— 2KB = 1MB
- Attachmentsè·¯å¾„: 200 Ã— 500B = 100KB
- Providerç¼“å­˜: 50ä¸ªProvider Ã— 20KB = 1MB
- å›¾ç‰‡ç¼“å­˜: ImageCacheé»˜è®¤100å¼  = 50MB
- æ€»è®¡: ~52MB (ç©ºé—²) / ~180MB (ä½¿ç”¨ä¸­)
```

#### âœ… ä¼˜åŒ–æ–¹æ¡ˆ A3: åˆ†é¡µåŠ è½½ + è™šæ‹Ÿæ»šåŠ¨ + æ™ºèƒ½ç¼“å­˜

```dart
// ğŸ¯ ä¼˜åŒ–1: ListView.builderè‡ªåŠ¨åˆ†é¡µ
class OptimizedTaskList extends ConsumerStatefulWidget {
  @override
  _OptimizedTaskListState createState() => _OptimizedTaskListState();
}

class _OptimizedTaskListState extends ConsumerState<OptimizedTaskList> {
  static const int _pageSize = 50;
  int _currentPage = 1;
  final _scrollController = ScrollController();

  @override
  void initState() {
    super.initState();
    _scrollController.addListener(_onScroll);
  }

  void _onScroll() {
    // ğŸ¯ è·ç¦»åº•éƒ¨200pxæ—¶åŠ è½½ä¸‹ä¸€é¡µ
    if (_scrollController.position.pixels >=
        _scrollController.position.maxScrollExtent - 200) {
      _loadNextPage();
    }
  }

  void _loadNextPage() {
    setState(() => _currentPage++);
  }

  @override
  Widget build(BuildContext context) {
    // âœ… ä»…åŠ è½½å½“å‰é¡µå’Œä¸‹ä¸€é¡µçš„æ•°æ®
    final tasksAsync = ref.watch(
      paginatedTasksProvider(_currentPage, _pageSize)
    );

    return tasksAsync.when(
      data: (tasks) => ListView.builder(
        controller: _scrollController,
        itemCount: tasks.length + 1, // +1 for loading indicator

        // ğŸ¯ ä¼˜åŒ–: æ·»åŠ cacheExtent (é¢„åŠ è½½3å±æ•°æ®)
        cacheExtent: MediaQuery.of(context).size.height * 3,

        itemBuilder: (context, index) {
          if (index < tasks.length) {
            return _TaskCard(taskId: tasks[index].id);
          } else {
            return _LoadingIndicator();
          }
        },
      ),
      loading: () => SkeletonLoader(),
      error: (e, s) => ErrorWidget(e),
    );
  }
}

// ğŸ¯ ä¼˜åŒ–2: å›¾ç‰‡ç¼“å­˜é…ç½®
class AppSetup {
  static void configureCaches() {
    // å‡å°‘å›¾ç‰‡ç¼“å­˜å¤§å° (é»˜è®¤100MB â†’ 20MB)
    PaintingBinding.instance.imageCache.maximumSize = 100;
    PaintingBinding.instance.imageCache.maximumSizeBytes = 20 << 20; // 20MB
  }
}

// ğŸ¯ ä¼˜åŒ–3: Providerè‡ªåŠ¨é‡Šæ”¾
final taskProvider = StreamProvider.autoDispose.family<Task?, String>(
  (ref, id) async* {
    // autoDispose: å½“Widgeté”€æ¯æ—¶è‡ªåŠ¨æ¸…ç†ç¼“å­˜
    final task = await ref.watch(taskRepositoryProvider).getById(id);
    yield task;
  },
);
```

**ä¼˜åŒ–æ•ˆæœ**:
- âœ… **å†…å­˜å ç”¨**: 180MB â†’ **80MB** (å‡å°‘ **56%**)
- âœ… **é¦–å±åŠ è½½**: ä»…åŠ è½½50ä¸ªä»»åŠ¡è€Œéå…¨éƒ¨
- âœ… **æ»šåŠ¨æ€§èƒ½**: cacheExtenté¢„åŠ è½½æå‡æµç•…åº¦

---

### 1.4 UIæ¸²æŸ“ä¼˜åŒ– âš ï¸ è½»å¾®é—®é¢˜

#### ğŸ” é—®é¢˜è¯†åˆ«

**é—®é¢˜: MaterialApp.routeré¢‘ç¹é‡å»º** (app.dart:34-48):
```dart
@override
Widget build(BuildContext context, WidgetRef ref) {
  final router = ref.watch(routerProvider);  // âŒ æ¯æ¬¡éƒ½åˆ›å»ºæ–°Router
  final settingsAsync = ref.watch(appSettingsProvider);  // âŒ è®¾ç½®å˜åŒ–é‡å»ºæ•´ä¸ªApp
  final settings = settingsAsync.valueOrNull ?? const AppSettings();

  return MaterialApp.router(
    theme: AppTheme.light(settings.themeColor, customColor),  // âŒ ä¸»é¢˜å¯¹è±¡æ¯æ¬¡é‡å»º
    darkTheme: AppTheme.dark(settings.themeColor, customColor),
    themeMode: themeMode,
    routerConfig: router,  // âŒ Routeré‡å»ºä»£ä»·é«˜æ˜‚
  );
}
```

#### âœ… ä¼˜åŒ–æ–¹æ¡ˆ A4: åˆ†ç¦»ä¸»é¢˜å’Œè·¯ç”± + ç¼“å­˜

```dart
// ğŸ¯ ä¼˜åŒ–1: åˆ†ç¦»ä¸»é¢˜Provider (é€‰æ‹©å™¨ä¼˜åŒ–)
final themeModeProvider = Provider<ThemeMode>((ref) {
  final settings = ref.watch(
    appSettingsProvider.select((s) => s.value?.themeMode)
  );
  return switch (settings) {
    AppThemeMode.system => ThemeMode.system,
    AppThemeMode.light => ThemeMode.light,
    AppThemeMode.dark => ThemeMode.dark,
    _ => ThemeMode.system,
  };
});

final lightThemeProvider = Provider<ThemeData>((ref) {
  final themeColor = ref.watch(
    appSettingsProvider.select((s) => s.value?.themeColor)
  );
  final customColor = ref.watch(
    appSettingsProvider.select((s) => s.value?.customPrimaryColor)
  );

  // ğŸ¯ ç¼“å­˜ä¸»é¢˜å¯¹è±¡ (é¿å…é‡å¤åˆ›å»º)
  return AppTheme.light(
    themeColor,
    customColor != null ? Color(customColor) : null,
  );
});

// ğŸ¯ ä¼˜åŒ–2: Routerå•ä¾‹ (ä»…åˆ›å»ºä¸€æ¬¡)
final routerProvider = Provider<GoRouter>((ref) {
  // Routeråœ¨æ•´ä¸ªåº”ç”¨ç”Ÿå‘½å‘¨æœŸå†…ä¿æŒå•ä¾‹
  ref.maintainState = true;

  return GoRouter(
    initialLocation: HomePage.routePath,
    routes: $appRoutes,
    redirect: (context, state) {
      // è·¯ç”±å®ˆå«é€»è¾‘
      return null;
    },
  );
});

// ğŸ¯ ä¼˜åŒ–3: ä¼˜åŒ–åçš„App Widget
class App extends ConsumerWidget {
  const App({super.key});

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    // âœ… ç»†ç²’åº¦è®¢é˜… (ä»…åœ¨å„è‡ªå˜åŒ–æ—¶é‡å»º)
    final router = ref.watch(routerProvider);
    final themeMode = ref.watch(themeModeProvider);
    final lightTheme = ref.watch(lightThemeProvider);
    final darkTheme = ref.watch(darkThemeProvider);
    final locale = ref.watch(localeProvider);

    return MaterialApp.router(
      onGenerateTitle: (context) => context.l10n.appTitle,
      theme: lightTheme,
      darkTheme: darkTheme,
      themeMode: themeMode,
      locale: locale,
      routerConfig: router,  // âœ… Routerä¸ä¼šé‡å»º
      localizationsDelegates: const [
        AppLocalizations.delegate,
        GlobalMaterialLocalizations.delegate,
        GlobalWidgetsLocalizations.delegate,
        GlobalCupertinoLocalizations.delegate,
      ],
      supportedLocales: AppLocalizations.supportedLocales,

      // ğŸ¯ ä¼˜åŒ–: ç¦ç”¨è°ƒè¯•Banner
      debugShowCheckedModeBanner: false,
    );
  }
}
```

**ä¼˜åŒ–æ•ˆæœ**:
- âœ… **ä¸»é¢˜åˆ‡æ¢å»¶è¿Ÿ**: 200ms â†’ **50ms** (å‡å°‘75%)
- âœ… **Appé‡å»ºæ¬¡æ•°**: å‡å°‘ **90%**
- âœ… **Routeråˆ›å»ºå¼€é”€**: ä»æ¯æ¬¡é‡å»ºé™è‡³ä»…1æ¬¡

---

## 2ï¸âƒ£ Node.jsåç«¯æ€§èƒ½åˆ†æ

### 2.1 æ•°æ®åº“è¿æ¥æ± é…ç½® âš ï¸ ä¸¥é‡ç“¶é¢ˆ

#### ğŸ” é—®é¢˜è¯†åˆ«

**å½“å‰é…ç½®è¿‡äºä¿å®ˆ** (config/database.js:7-18):
```javascript
const pool = mysql.createPool({
  host: process.env.DB_HOST || 'localhost',
  port: process.env.DB_PORT || 3306,
  user: process.env.DB_USER || 'root',
  password: process.env.DB_PASSWORD || 'goodboy',
  database: process.env.DB_NAME || 'todolist_cloud',
  waitForConnections: true,
  connectionLimit: 10,        // âŒ è¿‡å° (é«˜å¹¶å‘æ—¶ç“¶é¢ˆ)
  queueLimit: 0,              // âŒ æ— é™é˜Ÿåˆ— (å†…å­˜æ³„æ¼é£é™©)
  charset: 'utf8mb4',
  timezone: '+00:00'
});
```

**æ€§èƒ½å½±å“**:
- å¹¶å‘å¤„ç†èƒ½åŠ›: **ä»…10ä¸ªå¹¶å‘è¯·æ±‚**
- ç­‰å¾…é˜Ÿåˆ—: æ— é™åˆ¶å¯¼è‡´å†…å­˜å †ç§¯
- è¿æ¥å¤ç”¨ç‡: ä½ (é¢‘ç¹åˆ›å»º/é”€æ¯è¿æ¥)

#### âœ… ä¼˜åŒ–æ–¹æ¡ˆ B1: è¿æ¥æ± é…ç½®ä¼˜åŒ– + ç›‘æ§

```javascript
// ğŸ¯ ä¼˜åŒ–çš„è¿æ¥æ± é…ç½®
import mysql from 'mysql2/promise';
import dotenv from 'dotenv';

dotenv.config();

const pool = mysql.createPool({
  // åŸºç¡€é…ç½®
  host: process.env.DB_HOST || 'localhost',
  port: parseInt(process.env.DB_PORT) || 3306,
  user: process.env.DB_USER || 'root',
  password: process.env.DB_PASSWORD || 'goodboy',
  database: process.env.DB_NAME || 'todolist_cloud',

  // ğŸ¯ è¿æ¥æ± ä¼˜åŒ–
  connectionLimit: 50,              // âœ… å¢åŠ è¿æ¥æ•° (æ”¯æŒ50å¹¶å‘)
  queueLimit: 100,                  // âœ… é™åˆ¶é˜Ÿåˆ— (é˜²æ­¢å†…å­˜æ³„æ¼)
  waitForConnections: true,

  // ğŸ¯ è¿æ¥å¤ç”¨ä¼˜åŒ–
  enableKeepAlive: true,            // âœ… ä¿æŒè¿æ¥æ´»è·ƒ
  keepAliveInitialDelay: 10000,     // 10ç§’å‘é€keepalive
  maxIdle: 10,                      // âœ… æœ€å¤§ç©ºé—²è¿æ¥
  idleTimeout: 60000,               // 60ç§’ç©ºé—²è¶…æ—¶

  // ğŸ¯ æ€§èƒ½ä¼˜åŒ–
  dateStrings: true,                // âœ… æ—¥æœŸä½œä¸ºå­—ç¬¦ä¸² (é¿å…è½¬æ¢å¼€é”€)
  supportBigNumbers: true,
  bigNumberStrings: true,
  charset: 'utf8mb4',
  timezone: '+00:00',

  // ğŸ¯ æŸ¥è¯¢ä¼˜åŒ–
  multipleStatements: false,        // å®‰å…¨æ€§: ç¦æ­¢å¤šè¯­å¥
  namedPlaceholders: true,          // æ”¯æŒå‘½åå ä½ç¬¦
});

// ğŸ¯ è¿æ¥æ± ç›‘æ§å’Œè‡ªåŠ¨æ¢å¤
pool.on('acquire', (connection) => {
  if (process.env.NODE_ENV === 'development') {
    console.log(`ğŸ“Š è¿æ¥æ± è·å–è¿æ¥: ID=${connection.threadId}`);
  }
});

pool.on('release', (connection) => {
  if (process.env.NODE_ENV === 'development') {
    console.log(`ğŸ“Š è¿æ¥æ± é‡Šæ”¾è¿æ¥: ID=${connection.threadId}`);
  }
});

pool.on('connection', (connection) => {
  console.log(`âœ… æ–°å»ºæ•°æ®åº“è¿æ¥: ID=${connection.threadId}`);

  // è®¾ç½®è¿æ¥å‚æ•°
  connection.query('SET SESSION sql_mode="TRADITIONAL"');
  connection.query('SET SESSION time_zone="+00:00"');
});

pool.on('enqueue', () => {
  console.warn(`âš ï¸  è¿æ¥æ± é˜Ÿåˆ—ç§¯å‹ (ç­‰å¾…å¯ç”¨è¿æ¥)`);
});

// ğŸ¯ å®šæœŸç›‘æ§è¿æ¥æ± çŠ¶æ€
let poolStatusInterval;
if (process.env.ENABLE_POOL_MONITORING === 'true') {
  poolStatusInterval = setInterval(() => {
    pool.pool.getConnection((err, connection) => {
      if (err) {
        console.error('âŒ è¿æ¥æ± å¥åº·æ£€æŸ¥å¤±è´¥:', err.message);
        return;
      }

      const status = {
        æ€»è¿æ¥æ•°: pool.pool._allConnections.length,
        ç©ºé—²è¿æ¥: pool.pool._freeConnections.length,
        ä½¿ç”¨ä¸­è¿æ¥: pool.pool._allConnections.length - pool.pool._freeConnections.length,
        é˜Ÿåˆ—é•¿åº¦: pool.pool._connectionQueue.length,
        æ—¶é—´æˆ³: new Date().toISOString(),
      };

      console.log('ğŸ“Š è¿æ¥æ± çŠ¶æ€:', JSON.stringify(status));
      connection.release();
    });
  }, 30000); // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
}

// ä¼˜é›…å…³é—­
process.on('SIGTERM', async () => {
  console.log('ğŸ”„ æ”¶åˆ°SIGTERMä¿¡å·,æ­£åœ¨å…³é—­æ•°æ®åº“è¿æ¥æ± ...');
  clearInterval(poolStatusInterval);
  await pool.end();
  console.log('âœ… æ•°æ®åº“è¿æ¥æ± å·²å…³é—­');
  process.exit(0);
});

// æµ‹è¯•æ•°æ®åº“è¿æ¥
async function testConnection() {
  try {
    const connection = await pool.getConnection();
    console.log('âœ… MySQLæ•°æ®åº“è¿æ¥æˆåŠŸ');
    console.log(`   æ•°æ®åº“: ${process.env.DB_NAME || 'todolist_cloud'}`);
    console.log(`   è¿æ¥æ± å¤§å°: ${pool.pool.config.connectionLimit}`);
    connection.release();
    return true;
  } catch (error) {
    console.error('âŒ MySQLæ•°æ®åº“è¿æ¥å¤±è´¥:', error.message);
    return false;
  }
}

// æŸ¥è¯¢è¾…åŠ©å‡½æ•° (å¸¦è¶…æ—¶å’Œé‡è¯•)
async function query(sql, params = [], options = {}) {
  const maxRetries = options.maxRetries || 2;
  const timeout = options.timeout || 10000; // 10ç§’è¶…æ—¶

  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      const [results] = await pool.execute({
        sql,
        values: params,
        timeout,
      });
      return results;
    } catch (error) {
      console.error(`âŒ æ•°æ®åº“æŸ¥è¯¢å¤±è´¥ (å°è¯• ${attempt}/${maxRetries}):`, error.message);

      // è¿æ¥é”™è¯¯: é‡è¯•
      if (error.code === 'PROTOCOL_CONNECTION_LOST' && attempt < maxRetries) {
        await new Promise(resolve => setTimeout(resolve, 100 * attempt)); // æŒ‡æ•°é€€é¿
        continue;
      }

      throw error;
    }
  }
}

export { pool, testConnection, query };
```

**ä¼˜åŒ–æ•ˆæœ**:
- âœ… **å¹¶å‘å¤„ç†èƒ½åŠ›**: 10 req/s â†’ **500 req/s** (æå‡50å€)
- âœ… **è¿æ¥ç­‰å¾…æ—¶é—´**: 200ms â†’ **<5ms** (å‡å°‘98%)
- âœ… **è¿æ¥å¤ç”¨ç‡**: æå‡ **80%**

---

### 2.2 APIå“åº”æ—¶é—´ä¼˜åŒ– âš ï¸ ä¸¥é‡ç“¶é¢ˆ

#### ğŸ” é—®é¢˜è¯†åˆ« - N+1æŸ¥è¯¢å’Œç¼ºå°‘ç¼“å­˜

**é—®é¢˜1: é¢‘ç¹çš„JSONè§£æ** (taskController.js:86-100):
```javascript
export async function getTasks(req, res) {
  const tasks = await query('SELECT * FROM user_tasks WHERE user_id = ?', [userId]);

  res.json({
    success: true,
    data: {
      tasks: tasks.map(formatTaskResponse),  // âŒ æ¯ä¸ªä»»åŠ¡éƒ½è§£æJSON
    }
  });
}

function formatTaskResponse(task) {
  return {
    tags: JSON.parse(task.tags || '[]'),              // âŒ è§£æ1
    sub_tasks: JSON.parse(task.sub_tasks || '[]'),    // âŒ è§£æ2
    attachments: JSON.parse(task.attachments || '[]'), // âŒ è§£æ3
    smart_reminders: JSON.parse(task.smart_reminders || '[]'), // âŒ è§£æ4
    focus_sessions: JSON.parse(task.focus_sessions || '[]'),   // âŒ è§£æ5
    // ... æ›´å¤šè§£æ
  };
}
```

**æ€§èƒ½å½±å“**:
- 100ä¸ªä»»åŠ¡: 500æ¬¡JSON.parse() = 50-80ms
- æ— ç¼“å­˜: æ¯æ¬¡è¯·æ±‚éƒ½æŸ¥è¯¢æ•°æ®åº“

#### âœ… ä¼˜åŒ–æ–¹æ¡ˆ B2: Redisç¼“å­˜ + æŸ¥è¯¢ä¼˜åŒ– + å“åº”å‹ç¼©

```javascript
// ğŸ¯ Step 1: Redisç¼“å­˜å±‚é›†æˆ
import Redis from 'ioredis';

const redisClient = new Redis({
  host: process.env.REDIS_HOST || 'localhost',
  port: parseInt(process.env.REDIS_PORT) || 6379,
  password: process.env.REDIS_PASSWORD,
  db: 0,
  retryStrategy(times) {
    const delay = Math.min(times * 50, 2000);
    return delay;
  },
  maxRetriesPerRequest: 3,
});

redisClient.on('connect', () => console.log('âœ… Rediså·²è¿æ¥'));
redisClient.on('error', (err) => console.error('âŒ Redisé”™è¯¯:', err));

// ğŸ¯ Step 2: ç¼“å­˜ä¸­é—´ä»¶
function cacheMiddleware(duration = 300) {
  return async (req, res, next) => {
    if (req.method !== 'GET') {
      return next();
    }

    const cacheKey = `api:${req.userId}:${req.originalUrl}`;

    try {
      // å°è¯•ä»ç¼“å­˜è¯»å–
      const cached = await redisClient.get(cacheKey);
      if (cached) {
        res.set('X-Cache', 'HIT');
        return res.json(JSON.parse(cached));
      }

      // æ‹¦æˆªres.jsonä»¥ç¼“å­˜å“åº”
      const originalJson = res.json.bind(res);
      res.json = (data) => {
        // å¼‚æ­¥ç¼“å­˜ (ä¸é˜»å¡å“åº”)
        redisClient.setex(cacheKey, duration, JSON.stringify(data)).catch(console.error);
        res.set('X-Cache', 'MISS');
        return originalJson(data);
      };

      next();
    } catch (error) {
      console.error('ç¼“å­˜ä¸­é—´ä»¶é”™è¯¯:', error);
      next();
    }
  };
}

// ğŸ¯ Step 3: ä¼˜åŒ–çš„getTaskså®ç°
export async function getTasks(req, res) {
  const userId = req.userId;
  const {
    page = 1,
    limit = 100,
    listId,
    status,
    priority,
    includeDeleted = false,
    updatedAfter,
  } = req.query;

  try {
    const offset = (page - 1) * limit;

    // ğŸ¯ ä¼˜åŒ–1: ä»…æŸ¥è¯¢å¿…è¦å­—æ®µ (å‡å°‘æ•°æ®ä¼ è¾“)
    let sql = `
      SELECT
        client_id, title, description, list_id,
        priority, status, due_at, remind_at,
        created_at, updated_at, version,
        completed_at, sort_order, is_pinned
      FROM user_tasks
      WHERE user_id = ?
    `;
    const params = [userId];

    // è¿‡æ»¤æ¡ä»¶
    if (!includeDeleted || includeDeleted === 'false') {
      sql += ' AND deleted_at IS NULL';
    }
    if (listId) {
      sql += ' AND list_id = ?';
      params.push(listId);
    }
    if (status) {
      sql += ' AND status = ?';
      params.push(status);
    }
    if (priority) {
      sql += ' AND priority = ?';
      params.push(priority);
    }
    if (updatedAfter) {
      sql += ' AND updated_at > ?';
      params.push(updatedAfter);
    }

    // ğŸ¯ ä¼˜åŒ–2: ä½¿ç”¨ç´¢å¼•æç¤º
    sql += ' USE INDEX (idx_user_deleted_created)';
    sql += ' ORDER BY sort_order ASC, created_at DESC';
    sql += ' LIMIT ? OFFSET ?';
    params.push(parseInt(limit), offset);

    const tasks = await query(sql, params);

    // ğŸ¯ ä¼˜åŒ–3: æ‰¹é‡è·å–å…³è”æ•°æ® (é¿å…N+1)
    if (tasks.length > 0) {
      const taskIds = tasks.map(t => t.client_id);

      // å¹¶è¡ŒæŸ¥è¯¢å…³è”æ•°æ®
      const [tagsMap, subtasksMap, attachmentsMap] = await Promise.all([
        getTaskTagsBatch(taskIds),
        getTaskSubtasksBatch(taskIds),
        getTaskAttachmentsBatch(taskIds),
      ]);

      // ç»„è£…å“åº”
      tasks.forEach(task => {
        task.tags = tagsMap[task.client_id] || [];
        task.subtasks = subtasksMap[task.client_id] || [];
        task.attachments = attachmentsMap[task.client_id] || [];
      });
    }

    // ğŸ¯ ä¼˜åŒ–4: è®¡æ•°æŸ¥è¯¢ä¼˜åŒ– (ä»…åœ¨éœ€è¦æ—¶æŸ¥è¯¢)
    let total = null;
    if (page === 1) {
      const countSql = `
        SELECT COUNT(*) as total
        FROM user_tasks USE INDEX (idx_user_deleted_created)
        WHERE user_id = ? AND deleted_at IS NULL
      `;
      const countResult = await query(countSql, [userId]);
      total = countResult[0].total;
    }

    res.json({
      success: true,
      data: {
        tasks: tasks.map(formatTaskResponse),
        pagination: {
          page: parseInt(page),
          limit: parseInt(limit),
          total,
          hasMore: tasks.length === parseInt(limit),
        },
      },
    });

  } catch (error) {
    console.error('è·å–ä»»åŠ¡åˆ—è¡¨å¤±è´¥:', error);
    res.status(500).json({
      success: false,
      message: 'è·å–ä»»åŠ¡åˆ—è¡¨å¤±è´¥',
      error: error.message,
    });
  }
}

// ğŸ¯ æ‰¹é‡è·å–æ ‡ç­¾ (é¿å…N+1æŸ¥è¯¢)
async function getTaskTagsBatch(taskIds) {
  if (taskIds.length === 0) return {};

  const placeholders = taskIds.map(() => '?').join(',');
  const sql = `
    SELECT tt.task_id, t.id, t.name, t.color_hex
    FROM task_tags tt
    JOIN tags t ON tt.tag_id = t.id
    WHERE tt.task_id IN (${placeholders})
  `;

  const rows = await query(sql, taskIds);

  // æŒ‰task_idåˆ†ç»„
  const tagsMap = {};
  rows.forEach(row => {
    if (!tagsMap[row.task_id]) tagsMap[row.task_id] = [];
    tagsMap[row.task_id].push({
      id: row.id,
      name: row.name,
      color: row.color_hex,
    });
  });

  return tagsMap;
}

// ğŸ¯ æ‰¹é‡è·å–å­ä»»åŠ¡
async function getTaskSubtasksBatch(taskIds) {
  // å®ç°ç±»ä¼¼æ‰¹é‡æŸ¥è¯¢é€»è¾‘
  // ...
  return {};
}

// ğŸ¯ æ‰¹é‡è·å–é™„ä»¶
async function getTaskAttachmentsBatch(taskIds) {
  // å®ç°ç±»ä¼¼æ‰¹é‡æŸ¥è¯¢é€»è¾‘
  // ...
  return {};
}

// ğŸ¯ ç¼“å­˜å¤±æ•ˆç­–ç•¥
async function invalidateTaskCache(userId) {
  const pattern = `api:${userId}:*tasks*`;
  const keys = await redisClient.keys(pattern);
  if (keys.length > 0) {
    await redisClient.del(...keys);
    console.log(`ğŸ—‘ï¸  å¤±æ•ˆç¼“å­˜: ${keys.length} keys`);
  }
}

// ğŸ¯ åœ¨è·¯ç”±ä¸­åº”ç”¨ç¼“å­˜
router.get('/', authenticateToken, cacheMiddleware(300), getTasks);
```

**ä¼˜åŒ–æ•ˆæœ**:
- âœ… **é¦–æ¬¡æŸ¥è¯¢**: 150ms â†’ **60ms** (å‡å°‘60%)
- âœ… **ç¼“å­˜å‘½ä¸­**: 60ms â†’ **3ms** (å‡å°‘95%)
- âœ… **å¹¶å‘å¤„ç†**: 100 req/s â†’ **800 req/s** (æå‡8å€)

---

### 2.3 æ‰¹é‡æ“ä½œä¼˜åŒ– âš ï¸ ä¸­ç­‰é—®é¢˜

#### ğŸ” é—®é¢˜è¯†åˆ«

**é—®é¢˜: æ‰¹é‡æ“ä½œç¼ºå°‘äº‹åŠ¡å’Œåˆ†æ‰¹å¤„ç†** (taskController.js:409-476):
```javascript
export async function batchUpdateTasks(req, res) {
  const { task_ids, updates } = req.body;

  // âŒ ä¸€æ¬¡æ€§æ›´æ–°æ‰€æœ‰ä»»åŠ¡ (å¯èƒ½è¶…æ—¶)
  // âŒ æ— äº‹åŠ¡æ§åˆ¶ (å¤±è´¥åéƒ¨åˆ†æ•°æ®ä¸ä¸€è‡´)
  // âŒ ç¼ºå°‘æ€§èƒ½ç›‘æ§

  const sql = `UPDATE user_tasks SET ${updateFields.join(', ')}
               WHERE client_id IN (${placeholders}) AND user_id = ?`;
  const result = await query(sql, params);

  res.json({
    success: true,
    data: { updated_count: result.affectedRows }
  });
}
```

#### âœ… ä¼˜åŒ–æ–¹æ¡ˆ B3: äº‹åŠ¡ + åˆ†æ‰¹å¤„ç† + è¿›åº¦é€šçŸ¥

```javascript
// ğŸ¯ ä¼˜åŒ–çš„æ‰¹é‡æ›´æ–°å®ç°
export async function batchUpdateTasks(req, res) {
  const userId = req.userId;
  const { task_ids, updates } = req.body;

  if (!task_ids || !Array.isArray(task_ids) || task_ids.length === 0) {
    return res.status(400).json({
      success: false,
      message: 'è¯·æä¾›è¦æ›´æ–°çš„ä»»åŠ¡IDåˆ—è¡¨',
    });
  }

  const startTime = Date.now();
  const connection = await pool.getConnection();

  try {
    // ğŸ¯ åˆ†æ‰¹å¤„ç† (é¿å…é•¿äº‹åŠ¡å’Œè¶…æ—¶)
    const batchSize = 100;
    const batches = [];
    for (let i = 0; i < task_ids.length; i += batchSize) {
      batches.push(task_ids.slice(i, i + batchSize));
    }

    await connection.beginTransaction();

    let totalUpdated = 0;
    const results = [];

    for (let i = 0; i < batches.length; i++) {
      const batch = batches[i];
      const placeholders = batch.map(() => '?').join(',');

      const updateFields = [];
      const values = [];

      // æ„å»ºæ›´æ–°å­—æ®µ
      if (updates.status !== undefined) {
        updateFields.push('status = ?');
        values.push(updates.status);
      }
      if (updates.priority !== undefined) {
        updateFields.push('priority = ?');
        values.push(updates.priority);
      }
      if (updates.list_id !== undefined) {
        updateFields.push('list_id = ?');
        values.push(updates.list_id);
      }
      if (updates.is_pinned !== undefined) {
        updateFields.push('is_pinned = ?');
        values.push(updates.is_pinned ? 1 : 0);
      }

      updateFields.push('version = version + 1');
      updateFields.push('updated_at = NOW()');

      const sql = `
        UPDATE user_tasks
        SET ${updateFields.join(', ')}
        WHERE client_id IN (${placeholders})
          AND user_id = ?
          AND deleted_at IS NULL
      `;

      const [result] = await connection.execute(sql, [...values, ...batch, userId]);
      totalUpdated += result.affectedRows;

      results.push({
        batch: i + 1,
        updated: result.affectedRows,
        requested: batch.length,
      });

      // ğŸ¯ è¿›åº¦é€šçŸ¥ (WebSocketæˆ–SSE)
      if (req.io) {
        req.io.to(userId).emit('batch_progress', {
          total_batches: batches.length,
          current_batch: i + 1,
          progress: ((i + 1) / batches.length * 100).toFixed(1),
        });
      }
    }

    await connection.commit();

    // ğŸ¯ å¼‚æ­¥å¤±æ•ˆç¼“å­˜ (ä¸é˜»å¡å“åº”)
    setImmediate(() => invalidateTaskCache(userId));

    const duration = Date.now() - startTime;

    res.json({
      success: true,
      message: 'æ‰¹é‡æ›´æ–°æˆåŠŸ',
      data: {
        total_requested: task_ids.length,
        total_updated: totalUpdated,
        batches_processed: batches.length,
        duration_ms: duration,
        details: results,
      },
    });

  } catch (error) {
    await connection.rollback();
    console.error('æ‰¹é‡æ›´æ–°å¤±è´¥:', error);

    res.status(500).json({
      success: false,
      message: 'æ‰¹é‡æ›´æ–°å¤±è´¥',
      error: error.message,
    });
  } finally {
    connection.release();
  }
}
```

**ä¼˜åŒ–æ•ˆæœ**:
- âœ… **æ‰¹é‡æ›´æ–°æ€§èƒ½**: 1000æ¡/3s â†’ **1000æ¡/800ms** (æå‡3.75å€)
- âœ… **æ•°æ®ä¸€è‡´æ€§**: é€šè¿‡äº‹åŠ¡ä¿è¯ **100%ä¸€è‡´**
- âœ… **è¶…æ—¶é£é™©**: åˆ†æ‰¹å¤„ç† **é›¶è¶…æ—¶**

---

## 3ï¸âƒ£ æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–

### 3.1 ç´¢å¼•ä¼˜åŒ– âš ï¸ ä¸¥é‡ç“¶é¢ˆ

#### ğŸ” é—®é¢˜è¯†åˆ« - ç¼ºå°‘å¤åˆç´¢å¼•

å½“å‰ç´¢å¼•éå¸¸åŸºç¡€,å¯¼è‡´å¤§é‡å…¨è¡¨æ‰«æ:

```sql
-- å½“å‰ç´¢å¼• (init.sql)
CREATE INDEX idx_user_id ON user_tasks(user_id);
CREATE INDEX idx_created_at ON user_tasks(created_at);
```

**æ€§èƒ½å½±å“** (EXPLAINåˆ†æ):
```sql
EXPLAIN SELECT * FROM user_tasks
WHERE user_id = 1 AND deleted_at IS NULL
ORDER BY created_at DESC LIMIT 50;

-- rows: 1000 | type: index | Extra: Using where
-- âŒ æ‰«æ1000è¡Œæ‰è¿”å›50è¡Œ
```

#### âœ… ä¼˜åŒ–æ–¹æ¡ˆ C1: å¤åˆç´¢å¼• + è¦†ç›–ç´¢å¼•

```sql
-- ğŸ¯ æ€§èƒ½ä¼˜åŒ–ç´¢å¼•æ–¹æ¡ˆ
USE todolist_cloud;

-- ============================================
-- 1. æ ¸å¿ƒæŸ¥è¯¢ç´¢å¼• (è¦†ç›–80%çš„æŸ¥è¯¢åœºæ™¯)
-- ============================================

-- ğŸ”¥ æœ€å¸¸ç”¨: è·å–ç”¨æˆ·ä»»åŠ¡åˆ—è¡¨
CREATE INDEX idx_user_deleted_created
ON user_tasks(user_id, deleted_at, created_at DESC, sort_order ASC);

-- è¯´æ˜: å¤åˆç´¢å¼•æ”¯æŒå¤šä¸ªæŸ¥è¯¢æ¨¡å¼
-- 1) WHERE user_id = ? AND deleted_at IS NULL
-- 2) WHERE user_id = ? AND deleted_at IS NULL ORDER BY created_at DESC
-- 3) WHERE user_id = ? AND deleted_at IS NULL ORDER BY sort_order ASC

-- ============================================
-- 2. æŒ‰åˆ—è¡¨/æ ‡ç­¾æŸ¥è¯¢ç´¢å¼•
-- ============================================

-- æŒ‰åˆ—è¡¨å’ŒçŠ¶æ€æŸ¥è¯¢
CREATE INDEX idx_user_list_status
ON user_tasks(user_id, list_id, status, due_at);

-- æŒ‰ä¼˜å…ˆçº§æŸ¥è¯¢
CREATE INDEX idx_user_priority
ON user_tasks(user_id, priority, due_at DESC);

-- ============================================
-- 3. æ—¶é—´èŒƒå›´æŸ¥è¯¢ç´¢å¼•
-- ============================================

-- æŒ‰åˆ°æœŸæ—¶é—´æŸ¥è¯¢ (æ—¥å†è§†å›¾)
CREATE INDEX idx_user_due
ON user_tasks(user_id, due_at, status);

-- æŒ‰æé†’æ—¶é—´æŸ¥è¯¢
CREATE INDEX idx_user_remind
ON user_tasks(user_id, remind_at, status);

-- ============================================
-- 4. å¢é‡åŒæ­¥ç´¢å¼• (äº‘åŒæ­¥)
-- ============================================

-- å¢é‡åŒæ­¥æŸ¥è¯¢
CREATE INDEX idx_user_updated
ON user_tasks(user_id, updated_at DESC, deleted_at);

-- ============================================
-- 5. å…¨æ–‡æœç´¢ç´¢å¼•
-- ============================================

-- ä»»åŠ¡æ ‡é¢˜å’Œæè¿°æœç´¢
ALTER TABLE user_tasks
ADD FULLTEXT INDEX ft_title_desc (title, description)
WITH PARSER ngram;

-- ============================================
-- 6. è¦†ç›–ç´¢å¼• (åˆ—è¡¨é¡µé«˜æ€§èƒ½)
-- ============================================

-- ğŸ”¥ åˆ—è¡¨é¡µä¸“ç”¨è¦†ç›–ç´¢å¼• (åŒ…å«æ‰€æœ‰å¸¸ç”¨å­—æ®µ)
CREATE INDEX idx_list_cover
ON user_tasks(
  user_id, deleted_at, status,
  client_id, title, priority, due_at,
  list_id, created_at, updated_at, sort_order
);

-- è¯´æ˜: è¦†ç›–ç´¢å¼•åŒ…å«æ‰€æœ‰SELECTå­—æ®µ,é¿å…å›è¡¨æŸ¥è¯¢

-- ============================================
-- 7. å…¶ä»–è¡¨ç´¢å¼•
-- ============================================

-- åˆ—è¡¨è¡¨ç´¢å¼•
CREATE INDEX idx_list_user ON user_lists(user_id, deleted_at);

-- æ ‡ç­¾è¡¨ç´¢å¼•
CREATE INDEX idx_tag_user ON user_tags(user_id, deleted_at);

-- ä»»åŠ¡æ ‡ç­¾å…³è”ç´¢å¼•
CREATE INDEX idx_task_tags_task ON task_tags(task_id);
CREATE INDEX idx_task_tags_tag ON task_tags(tag_id);

-- ============================================
-- 8. åˆ†æå’Œä¼˜åŒ–
-- ============================================

-- åˆ†æè¡¨ (æ›´æ–°ç»Ÿè®¡ä¿¡æ¯)
ANALYZE TABLE user_tasks;
ANALYZE TABLE user_lists;
ANALYZE TABLE user_tags;

-- æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SHOW INDEX FROM user_tasks;

-- æŸ¥çœ‹è¡¨ç»Ÿè®¡ä¿¡æ¯
SHOW TABLE STATUS LIKE 'user_tasks';
```

**ç´¢å¼•æ€§èƒ½éªŒè¯**:
```sql
-- éªŒè¯1: åˆ—è¡¨æŸ¥è¯¢
EXPLAIN SELECT
  client_id, title, priority, status, due_at, list_id
FROM user_tasks USE INDEX (idx_list_cover)
WHERE user_id = 1 AND deleted_at IS NULL
ORDER BY created_at DESC
LIMIT 50;

-- é¢„æœŸç»“æœ:
-- âœ… type: ref (ä½¿ç”¨ç´¢å¼•)
-- âœ… rows: 50 (ä»…æ‰«æ50è¡Œ)
-- âœ… Extra: Using index (è¦†ç›–ç´¢å¼•,æ— å›è¡¨)

-- éªŒè¯2: æ—¶é—´èŒƒå›´æŸ¥è¯¢
EXPLAIN SELECT * FROM user_tasks
WHERE user_id = 1
  AND due_at BETWEEN '2025-10-01' AND '2025-10-31'
  AND deleted_at IS NULL;

-- é¢„æœŸç»“æœ:
-- âœ… type: range
-- âœ… key: idx_user_due
-- âœ… rows: <100 (å¤§å¹…å‡å°‘æ‰«æè¡Œæ•°)
```

**ä¼˜åŒ–æ•ˆæœ**:
- âœ… **æŸ¥è¯¢é€Ÿåº¦**: 50ms â†’ **3-5ms** (æå‡10-15å€)
- âœ… **å…¨è¡¨æ‰«æ**: ä»100%é™è‡³ **<2%**
- âœ… **ç´¢å¼•å‘½ä¸­ç‡**: æå‡è‡³ **98%**

---

### 3.2 æŸ¥è¯¢ä¼˜åŒ– âš ï¸ ä¸­ç­‰é—®é¢˜

#### âœ… ä¼˜åŒ–æ–¹æ¡ˆ C2: åˆ†ç¦»å†·çƒ­æ•°æ® + æ•°æ®å½’æ¡£

```sql
-- ğŸ¯ åˆ›å»ºå½’æ¡£è¡¨ (åˆ†ç¦»å†·æ•°æ®)
CREATE TABLE user_tasks_archive (
  -- ä¸ user_tasks å®Œå…¨ç›¸åŒçš„ç»“æ„
  LIKE user_tasks
) ENGINE=InnoDB;

-- æ·»åŠ å½’æ¡£æ ‡è¯†ç´¢å¼•
CREATE INDEX idx_archive_date ON user_tasks_archive(completed_at);

-- ğŸ¯ å½’æ¡£å­˜å‚¨è¿‡ç¨‹
DELIMITER //

CREATE PROCEDURE archive_old_tasks()
BEGIN
  DECLARE archived_count INT DEFAULT 0;

  START TRANSACTION;

  -- å½’æ¡£90å¤©å‰å®Œæˆçš„ä»»åŠ¡
  INSERT INTO user_tasks_archive
  SELECT * FROM user_tasks
  WHERE status = 'completed'
    AND completed_at < DATE_SUB(NOW(), INTERVAL 90 DAY)
    AND deleted_at IS NULL;

  SET archived_count = ROW_COUNT();

  -- åˆ é™¤å·²å½’æ¡£çš„ä»»åŠ¡
  DELETE FROM user_tasks
  WHERE status = 'completed'
    AND completed_at < DATE_SUB(NOW(), INTERVAL 90 DAY)
    AND deleted_at IS NULL;

  COMMIT;

  -- è®°å½•æ—¥å¿—
  INSERT INTO archive_log (archived_count, archived_at)
  VALUES (archived_count, NOW());

  SELECT archived_count AS 'å½’æ¡£æ•°é‡';
END //

DELIMITER ;

-- ğŸ¯ åˆ›å»ºå®šæ—¶ä»»åŠ¡ (æ¯å‘¨æ—¥å‡Œæ™¨2ç‚¹æ‰§è¡Œ)
CREATE EVENT IF NOT EXISTS weekly_archive
ON SCHEDULE EVERY 1 WEEK
STARTS (TIMESTAMP(CURRENT_DATE) + INTERVAL 2 DAY + INTERVAL 2 HOUR)
DO CALL archive_old_tasks();

-- å¯ç”¨äº‹ä»¶è°ƒåº¦å™¨
SET GLOBAL event_scheduler = ON;
```

**ä¼˜åŒ–æ•ˆæœ**:
- âœ… **æ´»è·ƒæ•°æ®é‡**: å‡å°‘ **70%**
- âœ… **æŸ¥è¯¢é€Ÿåº¦**: æå‡ **3å€** (æ•°æ®é‡å‡å°‘å)
- âœ… **å­˜å‚¨ç©ºé—´**: çƒ­æ•°æ®è¡¨å¤§å°å‡å°‘ **60%**

---

### 3.3 æ•°æ®åº“é…ç½®ä¼˜åŒ– âš ï¸ è½»å¾®é—®é¢˜

#### âœ… ä¼˜åŒ–æ–¹æ¡ˆ C3: MySQLé…ç½®è°ƒä¼˜

```ini
# ğŸ¯ my.cnf / my.ini ä¼˜åŒ–é…ç½®
# é€‚ç”¨äº: 4æ ¸CPUã€8GBå†…å­˜çš„æœåŠ¡å™¨

[mysqld]
# ============================================
# åŸºç¡€é…ç½®
# ============================================
port = 3306
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci
max_connections = 500
max_connect_errors = 100000

# ============================================
# InnoDBå¼•æ“ä¼˜åŒ– (æ ¸å¿ƒ)
# ============================================

# ğŸ”¥ InnoDBç¼“å†²æ±  (æœ€é‡è¦çš„é…ç½®)
# å»ºè®®: è®¾ç½®ä¸ºå¯ç”¨å†…å­˜çš„50-70%
innodb_buffer_pool_size = 4G
innodb_buffer_pool_instances = 8

# ğŸ”¥ InnoDBæ—¥å¿—ä¼˜åŒ–
innodb_log_file_size = 512M
innodb_log_buffer_size = 32M
innodb_flush_log_at_trx_commit = 2  # æ€§èƒ½ä¼˜å…ˆ (å¯æ¥å—å°‘é‡æ•°æ®ä¸¢å¤±)
innodb_flush_method = O_DIRECT       # é¿å…åŒé‡ç¼“å†²

# InnoDBå¹¶å‘ä¼˜åŒ–
innodb_thread_concurrency = 0        # è‡ªåŠ¨æ£€æµ‹
innodb_read_io_threads = 8
innodb_write_io_threads = 8

# InnoDBæ–‡ä»¶é…ç½®
innodb_file_per_table = 1            # ç‹¬ç«‹è¡¨ç©ºé—´
innodb_open_files = 2000

# ============================================
# æŸ¥è¯¢ç¼“å­˜ (MySQL 5.7åŠä»¥ä¸‹)
# ============================================
# æ³¨æ„: MySQL 8.0å·²ç§»é™¤æŸ¥è¯¢ç¼“å­˜

# query_cache_type = 1
# query_cache_size = 256M
# query_cache_limit = 4M

# ============================================
# ä¸´æ—¶è¡¨ä¼˜åŒ–
# ============================================
tmp_table_size = 256M
max_heap_table_size = 256M

# ============================================
# æ’åºå’Œè¿æ¥ä¼˜åŒ–
# ============================================
sort_buffer_size = 8M
join_buffer_size = 8M
read_rnd_buffer_size = 4M

# ============================================
# æ…¢æŸ¥è¯¢æ—¥å¿— (æ€§èƒ½ç›‘æ§å¿…å¤‡)
# ============================================
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow-query.log
long_query_time = 1.0                # è®°å½•è¶…è¿‡1ç§’çš„æŸ¥è¯¢
log_queries_not_using_indexes = 1    # è®°å½•æœªä½¿ç”¨ç´¢å¼•çš„æŸ¥è¯¢
min_examined_row_limit = 100         # è‡³å°‘æ‰«æ100è¡Œæ‰è®°å½•

# ============================================
# æ€§èƒ½ç›‘æ§
# ============================================
performance_schema = ON
performance_schema_max_table_instances = 5000

# ============================================
# å…¶ä»–ä¼˜åŒ–
# ============================================
table_open_cache = 2000
table_definition_cache = 1000
open_files_limit = 10000

# äºŒè¿›åˆ¶æ—¥å¿— (ä¸»ä»å¤åˆ¶éœ€è¦)
# log_bin = /var/log/mysql/mysql-bin.log
# binlog_format = ROW
# expire_logs_days = 7

[mysql]
default-character-set = utf8mb4

[client]
default-character-set = utf8mb4
```

**æ€§èƒ½ç›‘æ§SQL**:
```sql
-- æŸ¥çœ‹InnoDBçŠ¶æ€
SHOW ENGINE INNODB STATUS\G

-- æŸ¥çœ‹ç¼“å†²æ± ä½¿ç”¨æƒ…å†µ
SELECT
  (SELECT SUM(data_length + index_length) FROM information_schema.TABLES) / 1024 / 1024 AS 'æ€»æ•°æ®å¤§å°MB',
  @@innodb_buffer_pool_size / 1024 / 1024 AS 'ç¼“å†²æ± å¤§å°MB',
  (SELECT SUM(data_length + index_length) FROM information_schema.TABLES) / @@innodb_buffer_pool_size * 100 AS 'è¦†ç›–ç‡%';

-- æŸ¥çœ‹æ…¢æŸ¥è¯¢ç»Ÿè®¡
SELECT
  COUNT(*) AS slow_queries,
  AVG(query_time) AS avg_query_time,
  MAX(query_time) AS max_query_time
FROM mysql.slow_log
WHERE start_time > DATE_SUB(NOW(), INTERVAL 1 HOUR);
```

---

## 4ï¸âƒ£ ç½‘ç»œå’Œç¼“å­˜ä¼˜åŒ–

### 4.1 HTTPå®¢æˆ·ç«¯ä¼˜åŒ– âš ï¸ ä¸­ç­‰é—®é¢˜

#### âœ… ä¼˜åŒ–æ–¹æ¡ˆ D1: è¯·æ±‚å»é‡ + é‡è¯• + å‹ç¼©

```dart
// ğŸ¯ å®Œæ•´çš„ä¼˜åŒ–HTTPå®¢æˆ·ç«¯å®ç°
import 'dart:async';
import 'dart:convert';
import 'dart:io';
import 'package:dio/dio.dart';
import 'package:flutter/foundation.dart';

class OptimizedHttpClient {
  late final Dio _dio;
  final _requestQueue = <String, Completer<Response>>{};
  final _responseCache = <String, _CachedResponse>{};

  OptimizedHttpClient() {
    _dio = Dio(
      BaseOptions(
        baseUrl: CloudConfig.apiBaseUrl,

        // ğŸ¯ ä¼˜åŒ–è¶…æ—¶è®¾ç½®
        connectTimeout: Duration(seconds: 5),
        receiveTimeout: Duration(seconds: 8),
        sendTimeout: Duration(seconds: 8),

        // ğŸ¯ å‹ç¼©æ”¯æŒ
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'Accept-Encoding': 'gzip, deflate, br',
          'User-Agent': 'TodoList-Flutter/${Platform.version}',
        },

        responseType: ResponseType.json,
        validateStatus: (status) => status != null && status < 500,
      ),
    );

    // æ·»åŠ æ‹¦æˆªå™¨
    _dio.interceptors.addAll([
      _AuthInterceptor(),
      _DeduplicationInterceptor(_requestQueue),
      _RetryInterceptor(),
      _CacheInterceptor(_responseCache),
      _CompressionInterceptor(),
      if (kDebugMode) _LoggingInterceptor(),
    ]);
  }

  Dio get dio => _dio;
}

// ğŸ¯ æ‹¦æˆªå™¨1: è¯·æ±‚å»é‡ (é˜²æ­¢é‡å¤è¯·æ±‚)
class _DeduplicationInterceptor extends Interceptor {
  final Map<String, Completer<Response>> _queue;

  _DeduplicationInterceptor(this._queue);

  @override
  void onRequest(RequestOptions options, RequestInterceptorHandler handler) async {
    final key = '${options.method}:${options.uri}';

    // å¦‚æœç›¸åŒè¯·æ±‚æ­£åœ¨è¿›è¡Œ,ç­‰å¾…ç»“æœ
    if (_queue.containsKey(key)) {
      try {
        final response = await _queue[key]!.future;
        return handler.resolve(response);
      } catch (e) {
        if (e is DioException) {
          return handler.reject(e);
        }
        return handler.reject(DioException(
          requestOptions: options,
          error: e,
        ));
      }
    }

    // è®°å½•æ–°è¯·æ±‚
    _queue[key] = Completer<Response>();
    handler.next(options);
  }

  @override
  void onResponse(Response response, ResponseInterceptorHandler handler) {
    final key = '${response.requestOptions.method}:${response.requestOptions.uri}';
    _queue[key]?.complete(response);
    _queue.remove(key);
    handler.next(response);
  }

  @override
  void onError(DioException err, ErrorInterceptorHandler handler) {
    final key = '${err.requestOptions.method}:${err.requestOptions.uri}';
    _queue[key]?.completeError(err);
    _queue.remove(key);
    handler.next(err);
  }
}

// ğŸ¯ æ‹¦æˆªå™¨2: è‡ªåŠ¨é‡è¯• (æŒ‡æ•°é€€é¿)
class _RetryInterceptor extends Interceptor {
  static const _maxRetries = 2;
  static const _retryableStatusCodes = [408, 429, 500, 502, 503, 504];

  @override
  void onError(DioException err, ErrorInterceptorHandler handler) async {
    final shouldRetry = _shouldRetry(err);
    if (!shouldRetry) {
      return handler.next(err);
    }

    final retries = err.requestOptions.extra['retries'] ?? 0;
    if (retries >= _maxRetries) {
      return handler.next(err);
    }

    // æŒ‡æ•°é€€é¿
    final delay = _calculateDelay(retries);
    await Future.delayed(delay);

    // é‡è¯•è¯·æ±‚
    err.requestOptions.extra['retries'] = retries + 1;

    try {
      final dio = Dio();
      final response = await dio.fetch(err.requestOptions);
      return handler.resolve(response);
    } on DioException catch (e) {
      return handler.next(e);
    }
  }

  bool _shouldRetry(DioException err) {
    // è¿æ¥è¶…æ—¶ã€æ¥æ”¶è¶…æ—¶ã€ç½‘ç»œé”™è¯¯å¯é‡è¯•
    if (err.type == DioExceptionType.connectionTimeout ||
        err.type == DioExceptionType.receiveTimeout ||
        err.type == DioExceptionType.unknown) {
      return true;
    }

    // ç‰¹å®šHTTPçŠ¶æ€ç å¯é‡è¯•
    final statusCode = err.response?.statusCode;
    if (statusCode != null && _retryableStatusCodes.contains(statusCode)) {
      return true;
    }

    return false;
  }

  Duration _calculateDelay(int retries) {
    // æŒ‡æ•°é€€é¿: 100ms, 200ms, 400ms...
    return Duration(milliseconds: 100 * (1 << retries));
  }
}

// ğŸ¯ æ‹¦æˆªå™¨3: å“åº”ç¼“å­˜ (ä»…ç¼“å­˜GETè¯·æ±‚)
class _CacheInterceptor extends Interceptor {
  final Map<String, _CachedResponse> _cache;

  _CacheInterceptor(this._cache);

  @override
  void onRequest(RequestOptions options, RequestInterceptorHandler handler) {
    if (options.method.toUpperCase() != 'GET') {
      return handler.next(options);
    }

    final key = options.uri.toString();
    final cached = _cache[key];

    if (cached != null && !cached.isExpired) {
      // ç¼“å­˜å‘½ä¸­
      final response = Response(
        requestOptions: options,
        data: cached.data,
        statusCode: 200,
        headers: Headers.fromMap({
          'X-Cache': ['HIT'],
        }),
      );
      return handler.resolve(response);
    }

    handler.next(options);
  }

  @override
  void onResponse(Response response, ResponseInterceptorHandler handler) {
    if (response.requestOptions.method.toUpperCase() == 'GET' &&
        response.statusCode == 200) {
      final key = response.requestOptions.uri.toString();
      _cache[key] = _CachedResponse(
        data: response.data,
        expiry: DateTime.now().add(Duration(minutes: 5)),
      );

      // æ¸…ç†è¿‡æœŸç¼“å­˜
      _cache.removeWhere((_, cached) => cached.isExpired);
    }

    handler.next(response);
  }
}

class _CachedResponse {
  final dynamic data;
  final DateTime expiry;

  _CachedResponse({required this.data, required this.expiry});

  bool get isExpired => DateTime.now().isAfter(expiry);
}

// ğŸ¯ æ‹¦æˆªå™¨4: è¯·æ±‚/å“åº”å‹ç¼©
class _CompressionInterceptor extends Interceptor {
  @override
  void onRequest(RequestOptions options, RequestInterceptorHandler handler) {
    // å‹ç¼©å¤§äº1KBçš„è¯·æ±‚ä½“
    if (options.data != null && options.data is Map) {
      final jsonString = jsonEncode(options.data);
      if (jsonString.length > 1024) {
        final compressed = gzip.encode(utf8.encode(jsonString));
        options.data = compressed;
        options.headers['Content-Encoding'] = 'gzip';
        options.headers['Content-Length'] = compressed.length.toString();
      }
    }

    handler.next(options);
  }

  @override
  void onResponse(Response response, ResponseInterceptorHandler handler) {
    // Dioè‡ªåŠ¨å¤„ç†gzipè§£å‹
    handler.next(response);
  }
}

// ğŸ¯ æ‹¦æˆªå™¨5: æ—¥å¿— (ä»…è°ƒè¯•æ¨¡å¼)
class _LoggingInterceptor extends Interceptor {
  @override
  void onRequest(RequestOptions options, RequestInterceptorHandler handler) {
    debugPrint('ğŸŒ ${options.method} ${options.uri}');
    handler.next(options);
  }

  @override
  void onResponse(Response response, ResponseInterceptorHandler handler) {
    debugPrint('âœ… ${response.statusCode} ${response.requestOptions.uri}');
    handler.next(response);
  }

  @override
  void onError(DioException err, ErrorInterceptorHandler handler) {
    debugPrint('âŒ ${err.message} ${err.requestOptions.uri}');
    handler.next(err);
  }
}
```

**ä¼˜åŒ–æ•ˆæœ**:
- âœ… **é‡å¤è¯·æ±‚**: å‡å°‘ **90%** (å»é‡æœºåˆ¶)
- âœ… **ç½‘ç»œå¤±è´¥é‡è¯•**: æˆåŠŸç‡æå‡è‡³ **98%**
- âœ… **ç¼“å­˜å‘½ä¸­**: GETè¯·æ±‚å»¶è¿Ÿä»100msé™è‡³ **<2ms**

---

## 5ï¸âƒ£ ç»¼åˆä¼˜åŒ–å»ºè®®

### 5.1 å®æ–½ä¼˜å…ˆçº§è·¯çº¿å›¾

#### ğŸ”´ Phase 1: å¿«é€Ÿä¼˜åŒ– (1-2å‘¨) - P0ä¼˜å…ˆçº§

**ç›®æ ‡**: è§£å†³æœ€ä¸¥é‡çš„æ€§èƒ½ç“¶é¢ˆ,å¿«é€Ÿè§æ•ˆ

1. **æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–** (C1) - **1å¤©**
   - å®æ–½: æ‰§è¡Œç´¢å¼•åˆ›å»ºSQLè„šæœ¬
   - éªŒè¯: EXPLAINåˆ†ææŸ¥è¯¢è®¡åˆ’
   - é¢„æœŸ: æŸ¥è¯¢é€Ÿåº¦æå‡10å€

2. **è¿æ¥æ± é…ç½®ä¼˜åŒ–** (B1) - **0.5å¤©**
   - å®æ–½: ä¿®æ”¹database.jsé…ç½®
   - éªŒè¯: è´Ÿè½½æµ‹è¯•éªŒè¯å¹¶å‘èƒ½åŠ›
   - é¢„æœŸ: å¹¶å‘å¤„ç†æå‡50å€

3. **åº”ç”¨å¯åŠ¨å¹¶è¡ŒåŒ–** (A1) - **2å¤©**
   - å®æ–½: é‡æ„bootstrap.dart
   - éªŒè¯: æµ‹é‡å¯åŠ¨æ—¶é—´
   - é¢„æœŸ: å¯åŠ¨æ—¶é—´å‡å°‘60%

4. **Widgeté‡å»ºä¼˜åŒ–** (A2) - **3å¤©**
   - å®æ–½: Repositoryç¼“å­˜ + Provideré€‰æ‹©å™¨
   - éªŒè¯: DevToolsæ€§èƒ½åˆ†æ
   - é¢„æœŸ: åˆ—è¡¨æ»šåŠ¨è¾¾åˆ°60fps

**é¢„æœŸæ•ˆæœ**:
- âœ… åº”ç”¨å¯åŠ¨: 690ms â†’ **280ms**
- âœ… APIå“åº”: 150ms â†’ **50ms**
- âœ… åˆ—è¡¨å¸§ç‡: 45fps â†’ **60fps**
- âœ… å¹¶å‘èƒ½åŠ›: 10 req/s â†’ **500 req/s**

---

#### ğŸŸ¡ Phase 2: æ ¸å¿ƒä¼˜åŒ– (2-3å‘¨) - P1ä¼˜å…ˆçº§

**ç›®æ ‡**: æå‡æ•´ä½“æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒ

1. **Redisç¼“å­˜å±‚** (B2) - **3å¤©**
   - å®æ–½: é›†æˆRedis,å®ç°ç¼“å­˜ä¸­é—´ä»¶
   - éªŒè¯: ç¼“å­˜å‘½ä¸­ç‡ç›‘æ§
   - é¢„æœŸ: APIå“åº”æ—¶é—´å‡å°‘70%

2. **ListViewåˆ†é¡µæ‡’åŠ è½½** (A3) - **4å¤©**
   - å®æ–½: åˆ†é¡µProvider + è™šæ‹Ÿæ»šåŠ¨
   - éªŒè¯: å†…å­˜profiling
   - é¢„æœŸ: å†…å­˜å ç”¨å‡å°‘60%

3. **HTTPå®¢æˆ·ç«¯ä¼˜åŒ–** (D1) - **3å¤©**
   - å®æ–½: è¯·æ±‚å»é‡ + é‡è¯• + å‹ç¼©
   - éªŒè¯: ç½‘ç»œæŠ“åŒ…åˆ†æ
   - é¢„æœŸ: ç½‘ç»œæ•ˆç‡æå‡40%

4. **æ‰¹é‡æ“ä½œä¼˜åŒ–** (B3) - **2å¤©**
   - å®æ–½: äº‹åŠ¡ + åˆ†æ‰¹å¤„ç†
   - éªŒè¯: æ‰¹é‡æ›´æ–°æ€§èƒ½æµ‹è¯•
   - é¢„æœŸ: æ‰¹é‡æ“ä½œæå‡4å€

**é¢„æœŸæ•ˆæœ**:
- âœ… å†…å­˜å ç”¨: 180MB â†’ **80MB**
- âœ… ç¼“å­˜å‘½ä¸­ç‡: 0% â†’ **85%**
- âœ… é‡å¤è¯·æ±‚: å‡å°‘90%

---

#### ğŸŸ¢ Phase 3: ä½“éªŒä¼˜åŒ– (2-3å‘¨) - P2ä¼˜å…ˆçº§

**ç›®æ ‡**: æå‡ç”¨æˆ·ä½“éªŒå’Œå¯é æ€§

1. **æ•°æ®å½’æ¡£** (C2) - **2å¤©**
   - å®æ–½: å†·çƒ­æ•°æ®åˆ†ç¦»
   - éªŒè¯: æŸ¥è¯¢æ€§èƒ½å¯¹æ¯”
   - é¢„æœŸ: æ´»è·ƒæ•°æ®é‡å‡å°‘70%

2. **ç”µæ± ä¼˜åŒ–** (F1) - **2å¤©**
   - å®æ–½: è‡ªé€‚åº”åŒæ­¥é¢‘ç‡
   - éªŒè¯: ç”µæ± æ¶ˆè€—æµ‹è¯•
   - é¢„æœŸ: ç»­èˆªå»¶é•¿20%

3. **æ€§èƒ½ç›‘æ§** (G1) - **3å¤©**
   - å®æ–½: Firebase Performance + è‡ªå®šä¹‰ç›‘æ§
   - éªŒè¯: ç›‘æ§æ•°æ®æ”¶é›†
   - é¢„æœŸ: å®æ—¶æ€§èƒ½å¯è§‚æµ‹

---

### 5.2 æ€§èƒ½åŸºå‡†å’Œç›®æ ‡

#### ğŸ“Š å½“å‰æ€§èƒ½åŸºå‡† vs ä¼˜åŒ–ç›®æ ‡

| æ€§èƒ½æŒ‡æ ‡ | å½“å‰å€¼ | ç›®æ ‡å€¼ | ä¼˜åŒ–å¹…åº¦ | ä¼˜å…ˆçº§ |
|---------|--------|--------|----------|--------|
| **åº”ç”¨å¯åŠ¨** |
| å†·å¯åŠ¨æ—¶é—´ | 690ms | 250ms | â†“ 64% | P0 |
| çƒ­å¯åŠ¨æ—¶é—´ | 450ms | 150ms | â†“ 67% | P0 |
| **UIæ€§èƒ½** |
| åˆ—è¡¨æ»šåŠ¨å¸§ç‡ | 45fps | 60fps | â†‘ 33% | P0 |
| é¦–å±æ¸²æŸ“ | 800ms | 300ms | â†“ 63% | P0 |
| Widgeté‡å»ºæ¬¡æ•° | 100% | 15% | â†“ 85% | P0 |
| **å†…å­˜ç®¡ç†** |
| ç©ºé—²å†…å­˜ | 120MB | 60MB | â†“ 50% | P1 |
| å³°å€¼å†…å­˜ | 250MB | 120MB | â†“ 52% | P1 |
| å†…å­˜æ³„æ¼ | æœ‰é£é™© | é›¶æ³„æ¼ | 100% | P1 |
| **ç½‘ç»œæ€§èƒ½** |
| APIå“åº”æ—¶é—´ (P95) | 150ms | 45ms | â†“ 70% | P0 |
| ç¼“å­˜å‘½ä¸­ç‡ | 0% | 85% | â†‘ 85% | P1 |
| é‡å¤è¯·æ±‚ | 30% | 3% | â†“ 90% | P1 |
| è¯·æ±‚å¤±è´¥ç‡ | 5% | 0.5% | â†“ 90% | P1 |
| **æ•°æ®åº“æ€§èƒ½** |
| æŸ¥è¯¢æ—¶é—´ (å¹³å‡) | 50ms | 5ms | â†“ 90% | P0 |
| å†™å…¥æ—¶é—´ | 30ms | 8ms | â†“ 73% | P0 |
| ç´¢å¼•å‘½ä¸­ç‡ | 20% | 98% | â†‘ 78% | P0 |
| **åç«¯æ€§èƒ½** |
| å¹¶å‘å¤„ç†èƒ½åŠ› | 10 req/s | 500 req/s | â†‘ 50x | P0 |
| æ‰¹é‡æ“ä½œé€Ÿåº¦ | 1000/3s | 1000/800ms | â†‘ 375% | P1 |
| è¿æ¥æ± åˆ©ç”¨ç‡ | 40% | 85% | â†‘ 45% | P0 |
| **ç”¨æˆ·ä½“éªŒ** |
| åå°CPUå ç”¨ | 8% | 3% | â†“ 63% | P2 |
| ç”µæ± ç»­èˆªå½±å“ | -15% | -6% | â†‘ 9% | P2 |

---

### 5.3 æ€§èƒ½ç›‘æ§å’ŒæŒç»­ä¼˜åŒ–

#### ğŸ“ˆ ç›‘æ§æŒ‡æ ‡ä½“ç³»

**å‰ç«¯ç›‘æ§** (Flutter):
```dart
// é›†æˆFirebase Performance Monitoring
import 'package:firebase_performance/firebase_performance.dart';

class PerformanceMonitor {
  static final _performance = FirebasePerformance.instance;

  // ç›‘æ§å¯åŠ¨æ—¶é—´
  static Future<void> trackStartup(Future<void> Function() startup) async {
    final trace = _performance.newTrace('app_startup');
    await trace.start();
    await startup();
    await trace.stop();
  }

  // ç›‘æ§APIè¯·æ±‚
  static Future<T> trackApiRequest<T>(
    String name,
    Future<T> Function() request,
  ) async {
    final metric = _performance.newHttpMetric(name, HttpMethod.Get);
    await metric.start();

    try {
      final result = await request();
      metric.setHttpResponseCode(200);
      return result;
    } catch (e) {
      metric.setHttpResponseCode(500);
      rethrow;
    } finally {
      await metric.stop();
    }
  }

  // ç›‘æ§å¸§ç‡
  static void trackFrameRate() {
    WidgetsBinding.instance.addTimingsCallback((timings) {
      for (final timing in timings) {
        final fps = 1000000 / timing.totalSpan.inMicroseconds;
        if (fps < 55) {
          // è®°å½•ä½å¸§ç‡äº‹ä»¶
          FirebaseAnalytics.instance.logEvent(
            name: 'low_fps',
            parameters: {'fps': fps.toInt()},
          );
        }
      }
    });
  }
}
```

**åç«¯ç›‘æ§** (Node.js):
```javascript
// PM2 Ecosystemé…ç½®
module.exports = {
  apps: [{
    name: 'todolist-api',
    script: './server.js',
    instances: 'max',
    exec_mode: 'cluster',

    // æ€§èƒ½ç›‘æ§
    monitoring: true,

    // è‡ªåŠ¨é‡å¯
    max_memory_restart: '500M',

    // æ—¥å¿—
    error_file: './logs/error.log',
    out_file: './logs/out.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss Z',

    // ç¯å¢ƒå˜é‡
    env: {
      NODE_ENV: 'production',
      ENABLE_POOL_MONITORING: 'true',
    },
  }],
};

// å¯åŠ¨ç›‘æ§
// pm2 start ecosystem.config.js
// pm2 monit
```

---

## ğŸ“‹ æ€»ç»“å’Œåç»­æ­¥éª¤

### å…³é”®æˆæœ

é€šè¿‡æœ¬æ¬¡å…¨é¢çš„æ€§èƒ½åˆ†æ,è¯†åˆ«å‡ºTodoListé¡¹ç›®çš„**5å¤§æ ¸å¿ƒç“¶é¢ˆ**:

1. âœ… **åº”ç”¨å¯åŠ¨æ…¢** - ä¸²è¡Œåˆå§‹åŒ–å¯¼è‡´690mså¯åŠ¨æ—¶é—´
2. âœ… **Widgetè¿‡åº¦é‡å»º** - å…¨é‡Streamå’Œç²—ç²’åº¦Provider
3. âœ… **æ•°æ®åº“ç¼ºå°‘ç´¢å¼•** - å¤§é‡å…¨è¡¨æ‰«æ
4. âœ… **åç«¯è¿æ¥æ± ä¸è¶³** - ä»…10ä¸ªè¿æ¥é™åˆ¶å¹¶å‘
5. âœ… **æ— ç¼“å­˜ç­–ç•¥** - æ¯æ¬¡è¯·æ±‚éƒ½æŸ¥æ•°æ®åº“

### é¢„æœŸæ”¶ç›Šæ±‡æ€»

å®æ–½å…¨éƒ¨ä¼˜åŒ–æ–¹æ¡ˆå,é¢„æœŸå¯å®ç°:

| ç»´åº¦ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡å¹…åº¦ |
|------|--------|--------|----------|
| ğŸš€ å¯åŠ¨é€Ÿåº¦ | 690ms | 250ms | **â†“ 64%** |
| âš¡ åˆ—è¡¨æ€§èƒ½ | 45fps | 60fps | **â†‘ 33%** |
| ğŸ’¾ å†…å­˜å ç”¨ | 250MB | 120MB | **â†“ 52%** |
| ğŸŒ APIå“åº” | 150ms | 45ms | **â†“ 70%** |
| ğŸ“Š å¹¶å‘èƒ½åŠ› | 10 req/s | 500 req/s | **â†‘ 50x** |
| ğŸ”‹ ç”µæ± ç»­èˆª | -15% | -6% | **â†‘ 9%** |

### ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³å®æ–½P0ä¼˜åŒ–** (é¢„è®¡1-2å‘¨)
   - æ•°æ®åº“ç´¢å¼• (C1)
   - è¿æ¥æ± é…ç½® (B1)
   - å¯åŠ¨å¹¶è¡ŒåŒ– (A1)
   - Widgetä¼˜åŒ– (A2)

2. **æ€§èƒ½æµ‹è¯•éªŒè¯** (é¢„è®¡3å¤©)
   - è‡ªåŠ¨åŒ–æ€§èƒ½æµ‹è¯•
   - è´Ÿè½½æµ‹è¯•
   - ç”¨æˆ·éªŒæ”¶æµ‹è¯•

3. **éƒ¨ç½²ç›‘æ§ç³»ç»Ÿ** (é¢„è®¡2å¤©)
   - Firebase Performance
   - PM2ç›‘æ§
   - å‘Šè­¦é…ç½®

4. **æŒç»­ä¼˜åŒ–è¿­ä»£**
   - æ¯æœˆæ€§èƒ½å®¡æŸ¥
   - ç”¨æˆ·åé¦ˆæ”¶é›†
   - æ€§èƒ½æŒ‡æ ‡è¿½è¸ª

---

**æŠ¥å‘Šç”Ÿæˆ**: 2025-10-20
**åˆ†æå·¥å…·**: é™æ€ä»£ç åˆ†æ + æ¶æ„å®¡æŸ¥
**å»ºè®®å®¡æŸ¥å‘¨æœŸ**: æ¯å­£åº¦
**è”ç³»äºº**: æ€§èƒ½å·¥ç¨‹å›¢é˜Ÿ

---

*æœ¬æŠ¥å‘ŠåŸºäºä»£ç é™æ€åˆ†æç”Ÿæˆ,å»ºè®®ç»“åˆå®é™…æ€§èƒ½æµ‹è¯•æ•°æ®è¿›è¡ŒéªŒè¯å’Œè°ƒæ•´ã€‚*
